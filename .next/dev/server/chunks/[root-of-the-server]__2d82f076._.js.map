{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///Users/youngjepark/Documents/GitHub/ThangBackend/lib/firebaseAdmin.js"],"sourcesContent":["// lib/firebaseAdmin.js\nimport admin from \"firebase-admin\";\n\nif (!admin.apps.length) {\n  const projectId = process.env.FIREBASE_PROJECT_ID;\n  const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;\n  const privateKey = process.env.FIREBASE_PRIVATE_KEY;\n\n  if (!projectId || !clientEmail || !privateKey) {\n    console.error(\"[FirebaseAdmin] Missing required environment variables:\");\n    console.error(\"  - FIREBASE_PROJECT_ID:\", projectId ? \"✓\" : \"✗\");\n    console.error(\"  - FIREBASE_CLIENT_EMAIL:\", clientEmail ? \"✓\" : \"✗\");\n    console.error(\"  - FIREBASE_PRIVATE_KEY:\", privateKey ? \"✓\" : \"✗\");\n    throw new Error(\"Missing Firebase Admin credentials in environment variables\");\n  }\n\n  try {\n    admin.initializeApp({\n      credential: admin.credential.cert({\n        projectId,\n        clientEmail,\n        privateKey: privateKey.replace(/\\\\n/g, \"\\n\"),\n      }),\n    });\n    console.log(\"[FirebaseAdmin] Successfully initialized\");\n  } catch (error) {\n    console.error(\"[FirebaseAdmin] Initialization error:\", error);\n    throw error;\n  }\n}\n\nexport const adminAuth = admin.auth();\nexport const adminDb = admin.firestore();\n\nexport default admin;\n"],"names":[],"mappings":";;;;;;;;AAAA,uBAAuB;AACvB;;AAEA,IAAI,CAAC,qOAAK,CAAC,IAAI,CAAC,MAAM,EAAE;IACtB,MAAM,YAAY,QAAQ,GAAG,CAAC,mBAAmB;IACjD,MAAM,cAAc,QAAQ,GAAG,CAAC,qBAAqB;IACrD,MAAM,aAAa,QAAQ,GAAG,CAAC,oBAAoB;IAEnD,IAAI,CAAC,aAAa,CAAC,eAAe,CAAC,YAAY;QAC7C,QAAQ,KAAK,CAAC;QACd,QAAQ,KAAK,CAAC,4BAA4B,YAAY,MAAM;QAC5D,QAAQ,KAAK,CAAC,8BAA8B,cAAc,MAAM;QAChE,QAAQ,KAAK,CAAC,6BAA6B,aAAa,MAAM;QAC9D,MAAM,IAAI,MAAM;IAClB;IAEA,IAAI;QACF,qOAAK,CAAC,aAAa,CAAC;YAClB,YAAY,qOAAK,CAAC,UAAU,CAAC,IAAI,CAAC;gBAChC;gBACA;gBACA,YAAY,WAAW,OAAO,CAAC,QAAQ;YACzC;QACF;QACA,QAAQ,GAAG,CAAC;IACd,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yCAAyC;QACvD,MAAM;IACR;AACF;AAEO,MAAM,YAAY,qOAAK,CAAC,IAAI;AAC5B,MAAM,UAAU,qOAAK,CAAC,SAAS;uCAEvB,qOAAK"}},
    {"offset": {"line": 53, "column": 0}, "map": {"version":3,"sources":["file:///Users/youngjepark/Documents/GitHub/ThangBackend/lib/mongodb.js"],"sourcesContent":["import { MongoClient } from \"mongodb\";\n\nif (!process.env.MONGODB_URI) {\n  throw new Error('Invalid/Missing environment variable: \"MONGODB_URI\"');\n}\n\nconst uri = process.env.MONGODB_URI;\nconst options = {\n  maxPoolSize: 10,\n  serverSelectionTimeoutMS: 5000, // Fail after 5 seconds if cannot connect\n  socketTimeoutMS: 45000, // Close sockets after 45 seconds of inactivity\n};\n\nlet client;\nlet clientPromise;\n\nif (process.env.NODE_ENV === \"development\") {\n  // In development mode, use a global variable so that the value\n  // is preserved across module reloads caused by HMR (Hot Module Replacement).\n  if (!global._mongoClientPromise) {\n    client = new MongoClient(uri, options);\n    global._mongoClientPromise = client.connect();\n  }\n  clientPromise = global._mongoClientPromise;\n} else {\n  // In production mode, it's best to not use a global variable.\n  client = new MongoClient(uri, options);\n  clientPromise = client.connect();\n}\n\nexport default clientPromise;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,WAAW,EAAE;IAC5B,MAAM,IAAI,MAAM;AAClB;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,WAAW;AACnC,MAAM,UAAU;IACd,aAAa;IACb,0BAA0B;IAC1B,iBAAiB;AACnB;AAEA,IAAI;AACJ,IAAI;AAEJ,wCAA4C;IAC1C,+DAA+D;IAC/D,6EAA6E;IAC7E,IAAI,CAAC,yDAAO,mBAAmB,EAAE;QAC/B,SAAS,IAAI,2MAAW,CAAC,KAAK;QAC9B,yDAAO,mBAAmB,GAAG,OAAO,OAAO;IAC7C;IACA,gBAAgB,yDAAO,mBAAmB;AAC5C;;uCAMe"}},
    {"offset": {"line": 85, "column": 0}, "map": {"version":3,"sources":["file:///Users/youngjepark/Documents/GitHub/ThangBackend/pages/api/friends/list.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from \"next\";\nimport admin from \"@/lib/firebaseAdmin\";\nimport clientPromise from \"@/lib/mongodb\";\nimport { ObjectId } from \"mongodb\";\n\nconst DB_NAME = process.env.NEXT_PUBLIC_DB_NAME || \"game\";\n\nexport default async function handler(\n  req: NextApiRequest,\n  res: NextApiResponse\n) {\n  if (req.method !== \"GET\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  try {\n    // 1. Authenticate\n    const authHeader = req.headers.authorization;\n    if (!authHeader || !authHeader.startsWith(\"Bearer \")) {\n      return res.status(401).json({ error: \"Missing authorization header\" });\n    }\n    const token = authHeader.split(\"Bearer \")[1];\n    const decodedToken = await admin.auth().verifyIdToken(token);\n    const uid = decodedToken.uid;\n\n    // 2. Connect to DB\n    const client = await clientPromise;\n    const db = client.db(DB_NAME);\n    const users = db.collection(\"users\");\n\n    // 3. Fetch User Data to get Friend UIDs\n    const currentUser = await users.findOne(\n      { _id: uid },\n      { projection: { friends: 1, friendRequests: 1, blocked: 1 } }\n    );\n\n    if (!currentUser) {\n      return res.status(404).json({ error: \"User not found\" });\n    }\n\n    const friendList = currentUser.friends || [];\n    const friendRequests = currentUser.friendRequests || [];\n    const blockedUsers = currentUser.blocked || [];\n\n    // 4. Hydrate Friends with Real-Time Presence\n    // We need to fetch the latest data for each friend to check 'lastSeen'\n    const friendUids = friendList.map((f: any) => f.uid);\n\n    let hydratedFriends = [];\n    if (friendUids.length > 0) {\n      const friendsData = await users\n        .find(\n          { _id: { $in: friendUids } },\n          {\n            projection: {\n              username: 1,\n              lastSeen: 1,\n              status: 1,\n              rank: 1,\n              partyId: 1,\n            },\n          }\n        )\n        .toArray();\n\n      // Create a map for easy lookup\n      const friendsMap = new Map(friendsData.map((f) => [f._id, f]));\n\n      // Fetch Party Info for friends in parties\n      const partyIds = friendsData\n        .map((f) => f.partyId)\n        .filter((pid) => pid)\n        .map((pid) => new ObjectId(pid));\n\n      let partiesMap = new Map();\n      if (partyIds.length > 0) {\n        const partiesData = await db\n          .collection(\"parties\")\n          .find(\n            { _id: { $in: partyIds } },\n            { projection: { privacy: 1, members: 1 } }\n          )\n          .toArray();\n        partiesMap = new Map(partiesData.map((p) => [p._id.toString(), p]));\n      }\n\n      // Threshold for \"Online\" (e.g., seen in last 60 seconds)\n      // Heartbeat is every 30s, so 60s allows for 1 missed beat before offline.\n      const ONLINE_THRESHOLD_MS = 60 * 1000;\n      const now = new Date().getTime();\n\n      hydratedFriends = friendList.map((f: any) => {\n        const data = friendsMap.get(f.uid) as any;\n        if (!data) return f; // Should not happen unless friend deleted account\n\n        const lastSeenTime = data.lastSeen\n          ? new Date(data.lastSeen).getTime()\n          : 0;\n        const isRecent = now - lastSeenTime < ONLINE_THRESHOLD_MS;\n\n        // Determine effective status\n        // If explicitly \"offline\" OR timed out -> \"offline\"\n        // Otherwise use their status (e.g. \"online\", \"in-game\")\n        let effectiveStatus = \"offline\";\n        if (isRecent && data.status !== \"offline\") {\n          effectiveStatus = data.status || \"online\";\n        }\n\n        // Determine Party Info\n        let partyInfo = null;\n        if (data.partyId) {\n          const p = partiesMap.get(data.partyId.toString());\n          if (p) {\n            partyInfo = {\n              id: data.partyId.toString(),\n              privacy: p.privacy || \"private\",\n              isFull: (p.members?.length || 0) >= 5,\n            };\n          }\n        }\n\n        return {\n          uid: f.uid,\n          username: data.username || f.username, // Prefer latest username\n          addedAt: f.addedAt,\n          status: effectiveStatus,\n          lastSeen: data.lastSeen,\n          rank: data.rank || 0,\n          party: partyInfo,\n        };\n      });\n    }\n\n    // 5. Return Lists\n    return res.status(200).json({\n      friends: hydratedFriends,\n      friendRequests: friendRequests,\n      blocked: blockedUsers,\n    });\n  } catch (error: any) {\n    console.error(\"[Friend List] Error:\", error);\n    return res.status(500).json({ error: \"Internal Server Error\" });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}