{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///Users/youngjepark/Documents/GitHub/ThangBackend/lib/firebaseAdmin.js"],"sourcesContent":["// lib/firebaseAdmin.js\nimport admin from \"firebase-admin\";\n\nif (!admin.apps.length) {\n  const projectId = process.env.FIREBASE_PROJECT_ID;\n  const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;\n  const privateKey = process.env.FIREBASE_PRIVATE_KEY;\n\n  if (!projectId || !clientEmail || !privateKey) {\n    console.error(\"[FirebaseAdmin] Missing required environment variables:\");\n    console.error(\"  - FIREBASE_PROJECT_ID:\", projectId ? \"✓\" : \"✗\");\n    console.error(\"  - FIREBASE_CLIENT_EMAIL:\", clientEmail ? \"✓\" : \"✗\");\n    console.error(\"  - FIREBASE_PRIVATE_KEY:\", privateKey ? \"✓\" : \"✗\");\n    throw new Error(\"Missing Firebase Admin credentials in environment variables\");\n  }\n\n  try {\n    admin.initializeApp({\n      credential: admin.credential.cert({\n        projectId,\n        clientEmail,\n        privateKey: privateKey.replace(/\\\\n/g, \"\\n\"),\n      }),\n    });\n    console.log(\"[FirebaseAdmin] Successfully initialized\");\n  } catch (error) {\n    console.error(\"[FirebaseAdmin] Initialization error:\", error);\n    throw error;\n  }\n}\n\nexport const adminAuth = admin.auth();\nexport const adminDb = admin.firestore();\n\nexport default admin;\n"],"names":[],"mappings":";;;;;;;;AAAA,uBAAuB;AACvB;;AAEA,IAAI,CAAC,qOAAK,CAAC,IAAI,CAAC,MAAM,EAAE;IACtB,MAAM,YAAY,QAAQ,GAAG,CAAC,mBAAmB;IACjD,MAAM,cAAc,QAAQ,GAAG,CAAC,qBAAqB;IACrD,MAAM,aAAa,QAAQ,GAAG,CAAC,oBAAoB;IAEnD,IAAI,CAAC,aAAa,CAAC,eAAe,CAAC,YAAY;QAC7C,QAAQ,KAAK,CAAC;QACd,QAAQ,KAAK,CAAC,4BAA4B,YAAY,MAAM;QAC5D,QAAQ,KAAK,CAAC,8BAA8B,cAAc,MAAM;QAChE,QAAQ,KAAK,CAAC,6BAA6B,aAAa,MAAM;QAC9D,MAAM,IAAI,MAAM;IAClB;IAEA,IAAI;QACF,qOAAK,CAAC,aAAa,CAAC;YAClB,YAAY,qOAAK,CAAC,UAAU,CAAC,IAAI,CAAC;gBAChC;gBACA;gBACA,YAAY,WAAW,OAAO,CAAC,QAAQ;YACzC;QACF;QACA,QAAQ,GAAG,CAAC;IACd,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yCAAyC;QACvD,MAAM;IACR;AACF;AAEO,MAAM,YAAY,qOAAK,CAAC,IAAI;AAC5B,MAAM,UAAU,qOAAK,CAAC,SAAS;uCAEvB,qOAAK"}},
    {"offset": {"line": 53, "column": 0}, "map": {"version":3,"sources":["file:///Users/youngjepark/Documents/GitHub/ThangBackend/lib/mongodb.js"],"sourcesContent":["import { MongoClient } from \"mongodb\";\n\nif (!process.env.MONGODB_URI) {\n  throw new Error('Invalid/Missing environment variable: \"MONGODB_URI\"');\n}\n\nconst uri = process.env.MONGODB_URI;\nconst options = {\n  maxPoolSize: 10,\n};\n\nlet client;\nlet clientPromise;\n\nif (process.env.NODE_ENV === \"development\") {\n  // In development mode, use a global variable so that the value\n  // is preserved across module reloads caused by HMR (Hot Module Replacement).\n  if (!global._mongoClientPromise) {\n    client = new MongoClient(uri, options);\n    global._mongoClientPromise = client.connect();\n  }\n  clientPromise = global._mongoClientPromise;\n} else {\n  // In production mode, it's best to not use a global variable.\n  client = new MongoClient(uri, options);\n  clientPromise = client.connect();\n}\n\nexport default clientPromise;\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,WAAW,EAAE;IAC5B,MAAM,IAAI,MAAM;AAClB;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,WAAW;AACnC,MAAM,UAAU;IACd,aAAa;AACf;AAEA,IAAI;AACJ,IAAI;AAEJ,wCAA4C;IAC1C,+DAA+D;IAC/D,6EAA6E;IAC7E,IAAI,CAAC,yDAAO,mBAAmB,EAAE;QAC/B,SAAS,IAAI,2MAAW,CAAC,KAAK;QAC9B,yDAAO,mBAAmB,GAAG,OAAO,OAAO;IAC7C;IACA,gBAAgB,yDAAO,mBAAmB;AAC5C;;uCAMe"}},
    {"offset": {"line": 83, "column": 0}, "map": {"version":3,"sources":["file:///Users/youngjepark/Documents/GitHub/ThangBackend/pages/api/auth/bootstrap.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from \"next\";\nimport admin from \"@/lib/firebaseAdmin\";\nimport clientPromise from \"@/lib/mongodb\";\n\nconst DB_NAME = process.env.NEXT_PUBLIC_DB_NAME || \"game\";\n\ninterface User {\n  _id: string;\n  email: string;\n  username?: string | null;\n  rank: number;\n  coins: number;\n  created_at: Date;\n  updated_at: Date;\n}\n\ntype ResponseData = User | { error: string };\n\nexport default async function handler(\n  req: NextApiRequest,\n  res: NextApiResponse<ResponseData>\n) {\n  // Only allow POST requests\n  if (req.method !== \"POST\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  try {\n    // Extract and validate Firebase token\n    const token = req.headers.authorization?.split(\"Bearer \")[1];\n    if (!token) {\n      return res.status(401).json({ error: \"Missing authorization token\" });\n    }\n\n    // Verify Firebase ID token\n    let decoded;\n    try {\n      console.log(\"[Bootstrap] Verifying Firebase token...\");\n      decoded = await admin.auth().verifyIdToken(token);\n      console.log(\"[Bootstrap] Token verified for UID:\", decoded.uid);\n    } catch (error: any) {\n      console.error(\"[Bootstrap] Firebase verification error:\", error.message);\n      return res.status(401).json({ error: \"Invalid or expired token\" });\n    }\n\n    const uid = decoded.uid;\n    const email = decoded.email || \"\";\n\n    if (!uid) {\n      return res.status(401).json({ error: \"Invalid token: missing uid\" });\n    }\n\n    // Connect to MongoDB\n    console.log(\"[Bootstrap] Connecting to MongoDB...\");\n    const client = await clientPromise;\n    console.log(\"[Bootstrap] Connected to MongoDB\");\n\n    const db = client.db(DB_NAME);\n    const users = db.collection(\"users\");\n\n    // Ensure username uniqueness without forcing it on existing docs\n    try {\n      await users.createIndex({ username: 1 }, { unique: true, sparse: true });\n    } catch (indexError: any) {\n      // Log and continue if index already exists or cannot be created\n      console.warn(\"[Bootstrap] Username index warning:\", indexError.message);\n    }\n\n    // _id already has a unique index by default; no need to recreate\n\n    // Try to find existing user\n    console.log(\"[Bootstrap] Looking for existing user:\", uid);\n    let user = await users.findOne({ _id: uid });\n    console.log(\"[Bootstrap] User found:\", user ? \"yes\" : \"no\");\n\n    // If user doesn't exist, create a new one\n    if (!user) {\n      const newUser: User = {\n        _id: uid,\n        email,\n        username: null,\n        rank: 0,\n        coins: 100,\n        created_at: new Date(),\n        updated_at: new Date(),\n      };\n\n      try {\n        console.log(\"[Bootstrap] Creating new user:\", uid);\n        await users.insertOne(newUser);\n        user = newUser;\n        console.log(\"[Bootstrap] User created successfully\");\n      } catch (insertError: any) {\n        // Handle race condition where user was created between findOne and insertOne\n        if (insertError.code === 11000) {\n          console.log(\n            \"[Bootstrap] Race condition detected, fetching user again\"\n          );\n          user = await users.findOne({ _id: uid });\n          if (!user) {\n            throw insertError;\n          }\n        } else {\n          throw insertError;\n        }\n      }\n    }\n\n    console.log(\"[Bootstrap] Returning user data\");\n    return res.status(200).json(user);\n  } catch (error) {\n    console.error(\n      \"[Bootstrap] CRITICAL ERROR:\",\n      error instanceof Error ? error.message : String(error)\n    );\n    if (error instanceof Error) {\n      console.error(\"[Bootstrap] Stack:\", error.stack);\n    }\n    return res.status(500).json({ error: \"Internal server error\" });\n  }\n}\n"],"names":[],"mappings":";;;;AACA;AACA;;;AAEA,MAAM,UAAU,QAAQ,GAAG,CAAC,mBAAmB,IAAI;AAcpC,eAAe,QAC5B,GAAmB,EACnB,GAAkC;IAElC,2BAA2B;IAC3B,IAAI,IAAI,MAAM,KAAK,QAAQ;QACzB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAqB;IAC5D;IAEA,IAAI;QACF,sCAAsC;QACtC,MAAM,QAAQ,IAAI,OAAO,CAAC,aAAa,EAAE,MAAM,UAAU,CAAC,EAAE;QAC5D,IAAI,CAAC,OAAO;YACV,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA8B;QACrE;QAEA,2BAA2B;QAC3B,IAAI;QACJ,IAAI;YACF,QAAQ,GAAG,CAAC;YACZ,UAAU,MAAM,+JAAK,CAAC,IAAI,GAAG,aAAa,CAAC;YAC3C,QAAQ,GAAG,CAAC,uCAAuC,QAAQ,GAAG;QAChE,EAAE,OAAO,OAAY;YACnB,QAAQ,KAAK,CAAC,4CAA4C,MAAM,OAAO;YACvE,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA2B;QAClE;QAEA,MAAM,MAAM,QAAQ,GAAG;QACvB,MAAM,QAAQ,QAAQ,KAAK,IAAI;QAE/B,IAAI,CAAC,KAAK;YACR,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAA6B;QACpE;QAEA,qBAAqB;QACrB,QAAQ,GAAG,CAAC;QACZ,MAAM,SAAS,MAAM,yJAAa;QAClC,QAAQ,GAAG,CAAC;QAEZ,MAAM,KAAK,OAAO,EAAE,CAAC;QACrB,MAAM,QAAQ,GAAG,UAAU,CAAC;QAE5B,iEAAiE;QACjE,IAAI;YACF,MAAM,MAAM,WAAW,CAAC;gBAAE,UAAU;YAAE,GAAG;gBAAE,QAAQ;gBAAM,QAAQ;YAAK;QACxE,EAAE,OAAO,YAAiB;YACxB,gEAAgE;YAChE,QAAQ,IAAI,CAAC,uCAAuC,WAAW,OAAO;QACxE;QAEA,iEAAiE;QAEjE,4BAA4B;QAC5B,QAAQ,GAAG,CAAC,0CAA0C;QACtD,IAAI,OAAO,MAAM,MAAM,OAAO,CAAC;YAAE,KAAK;QAAI;QAC1C,QAAQ,GAAG,CAAC,2BAA2B,OAAO,QAAQ;QAEtD,0CAA0C;QAC1C,IAAI,CAAC,MAAM;YACT,MAAM,UAAgB;gBACpB,KAAK;gBACL;gBACA,UAAU;gBACV,MAAM;gBACN,OAAO;gBACP,YAAY,IAAI;gBAChB,YAAY,IAAI;YAClB;YAEA,IAAI;gBACF,QAAQ,GAAG,CAAC,kCAAkC;gBAC9C,MAAM,MAAM,SAAS,CAAC;gBACtB,OAAO;gBACP,QAAQ,GAAG,CAAC;YACd,EAAE,OAAO,aAAkB;gBACzB,6EAA6E;gBAC7E,IAAI,YAAY,IAAI,KAAK,OAAO;oBAC9B,QAAQ,GAAG,CACT;oBAEF,OAAO,MAAM,MAAM,OAAO,CAAC;wBAAE,KAAK;oBAAI;oBACtC,IAAI,CAAC,MAAM;wBACT,MAAM;oBACR;gBACF,OAAO;oBACL,MAAM;gBACR;YACF;QACF;QAEA,QAAQ,GAAG,CAAC;QACZ,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;IAC9B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CACX,+BACA,iBAAiB,QAAQ,MAAM,OAAO,GAAG,OAAO;QAElD,IAAI,iBAAiB,OAAO;YAC1B,QAAQ,KAAK,CAAC,sBAAsB,MAAM,KAAK;QACjD;QACA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAwB;IAC/D;AACF"}}]
}